name: CI for tunnel and web socket proxies

on: 
  push:
    paths:
      - "websocket-proxy/**"
      - "proxy/**"
  pull_request:
      paths:
      - "websocket-proxy/**"
      - "proxy/**"


jobs:
  test_websocket_proxy:
    name: "Test Python websocket proxy"
    runs-on: ubuntu-20.04
    env:
      API_URL: "https://api.epaper.opendatahub.testingmachine.eu"
      WS_URL: "ws://localhost/ws"

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          cache: 'pip'

      - run: pip install -r requirements.txt
        working-directory: websocket-proxy

      - run: |
          echo "API_URL=$API_URL" > .env
          echo "WS_URL=$WS_URL" >> .env
          timeout -s SIGKILL 5 python3 websocket-proxy.py || test "137" = "$?"
        working-directory: websocket-proxy
  
  test_tunnel_proxy:
    name: "Test Python tunnel proxy"
    runs-on: ubuntu-20.04
    env:
       API_URL: "https://api.epaper.opendatahub.testingmachine.eu"
       WS_URL: "ws://localhost/ws"

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          cache: 'pip'

      - run: pip install -r requirements.txt
        working-directory: proxy

      - run: |
          echo "API_URL=${API_URL}" > .env
          touch local-tunnel.log
          timeout -s SIGKILL 5 python3 proxy.py || test "137" = "$?"
        working-directory: proxy